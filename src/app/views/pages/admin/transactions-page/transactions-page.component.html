<div class="container mt-5 mb-5 pt-5">

  <!-- 🔄 Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2">Loading purchase summary...</p>
  </div>

  <!-- ⚠️ Error -->
  <div *ngIf="!loading && errorMessage" class="alert alert-danger text-center">
    {{ errorMessage }}
  </div>

  <!-- ✅ Content -->
  <div *ngIf="!loading && purchaseSummary.length">

    <!-- 🎛 Filters Section -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-semibold">Category</label>
            <select class="form-select form-select-sm" [(ngModel)]="filterCategory">
              <option value="">All Categories</option>
              <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Status</label>
            <select class="form-select form-select-sm" [(ngModel)]="filterStatus">
              <option value="">All Status</option>
              <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold">Month</label>
            <input type="month" class="form-control form-control-sm" [(ngModel)]="filterMonth">
          </div>

          <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-sm btn-primary w-50" (click)="applyFilters()">Apply</button>
            <button class="btn btn-sm btn-outline-secondary w-50" (click)="resetFilters()">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 📊 Purchases Table -->
    <div class="table-responsive shadow-sm rounded bg-white ">
      <table class="table table-bordered table-hover align-middle" style="font-size: 14px;">
        <thead class="table-light text-center">
          <tr>
            <th>#</th>
            <th>Course</th>
            <th>Thumbnail</th>
            <th>Category</th>
            <th>Status</th>
            <th>Month</th>
            <th>Student</th>
            <th>Email</th>
            <th>Instructor</th>
            <th>Paid</th>
            <th>Course Price</th>
            <th>Tax</th>
            <th>Platform Fee</th>
            <th>Instructor Revenue</th>
            <th>Admin Revenue</th>
            <th>Refunded</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let item of filteredSummary; let i = index">
            <td class="text-center">{{ i + 1 }}</td>
            <td class="fw-semibold">{{ item.courseTitle }}</td>
            <td class="text-center">
              <img [src]="item.courseThumbnail" alt="Thumbnail" class="rounded" style="width: 60px; height: 40px; object-fit: cover;">
            </td>
            <td>{{ item.courseCategory }}</td>

            <!-- 🎨 Status Badge -->
            <td class="text-center">
              <span class="badge px-3 py-2" [ngClass]="{'bg-success': item.statusLabel.toLowerCase() === 'purchased', 'bg-danger': item.statusLabel.toLowerCase() === 'refunded', 'bg-secondary': item.statusLabel.toLowerCase() === 'non-refundable'}">
                {{ item.statusLabel | titlecase }}
              </span>
            </td>

            <td>{{ item.month }}</td>
            <td>{{ item.studentName }}</td>
            <td>{{ item.studentEmail }}</td>
            <td>{{ item.courseInstructorName }}</td>

            <!-- 💰 Finance Fields -->
            <td class="text-end">{{ item.amount | currency:'INR' }}</td>
            <td class="text-end">{{ item.coursePrice | currency:'INR' }}</td>
            <td class="text-end">{{ item.taxCharges | currency:'INR' }}</td>
            <td class="text-end">{{ item.platformFee | currency:'INR' }}</td>
            <td class="text-end">{{ item.revenueForInstructor | currency:'INR' }}</td>
            <td class="text-end">{{ item.revenueForAdmin | currency:'INR' }}</td>
            <td class="text-end text-danger fw-semibold">{{ item.refundedAmount | currency:'INR' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

      <div class="d-flex align-items-center justify-content-between mt-4 flex-wrap gap-3">

    <!-- Left: Items per page -->
    <div class="d-flex align-items-center">
      <label for="itemsPerPage" class="me-2 mb-0 fw-semibold">Show</label>
      <select id="itemsPerPage" [(ngModel)]="itemsPerPage" (change)="updatePagination()"
              class="form-select form-select-sm  shadow-sm"
              style="width: 70px;">
        <option *ngFor="let size of [5,10,20,50]" [value]="size">{{ size }}</option>
      </select>
    </div>

    <!-- Center: Pagination -->
    <nav>
      <ul class="pagination pagination-sm mb-0 shadow-sm  overflow-hidden">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="onPageChange(currentPage - 1)" href="javascript:void(0)">&laquo;</a>
        </li>
        <li *ngFor="let page of pageNumbers" class="page-item" [class.active]="page === currentPage">
          <a class="page-link" (click)="onPageChange(page)" href="javascript:void(0)">{{ page }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="onPageChange(currentPage + 1)" href="javascript:void(0)">&raquo;</a>
        </li>
      </ul>
    </nav>

    <!-- Right: Page info -->
    <div class="text-muted small">
      Page <span class="fw-semibold">{{ currentPage }}</span> of <span class="fw-semibold">{{ totalPages }}</span>
    </div>
  </div>

    <!-- 📌 Footer -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <p class="mb-0">
        <strong>Total Purchases:</strong> {{ totalLength }}
      </p>
      <button class="btn btn-sm btn-outline-primary">Export CSV</button>
    </div>

  </div>
</div>
